{% extends "base.html" %}

{% block title %}Dashboard - OCC Price Forecasting{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h1 class="display-4 mb-3">
                    <i class="fas fa-chart-line me-3"></i>
                    OCC Price Forecasting Dashboard
                </h1>
                <p class="lead">Advanced machine learning-powered forecasting for Old Corrugated Cardboard prices</p>
                <div class="row mt-4">
                    <div class="col-md-3">
                        <h3>{{ data_summary.metadata.total_records or 0 }}</h3>
                        <p>Data Points</p>
                    </div>
                    <div class="col-md-3">
                        <h3>${{ "%.2f"|format(data_summary.metadata.mean_price or 0) }}</h3>
                        <p>Average Price</p>
                    </div>
                    <div class="col-md-3">
                        <h3>{{ model_info.best_model or 'N/A' }}</h3>
                        <p>Best Model</p>
                    </div>
                    <div class="col-md-3">
                        <h3>{{ data_summary.metadata.date_range_end or 'N/A' }}</h3>
                        <p>Latest Data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="feature-icon">
                    <i class="fas fa-crystal-ball"></i>
                </div>
                <h5 class="card-title">Generate Forecast</h5>
                <p class="card-text">Create price forecasts for 1-12 months using our advanced ML models.</p>
                <a href="{{ url_for('forecast') }}" class="btn btn-primary">
                    <i class="fas fa-arrow-right me-2"></i>Start Forecasting
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="feature-icon">
                    <i class="fas fa-database"></i>
                </div>
                <h5 class="card-title">Update Data</h5>
                <p class="card-text">Add new actual price data and automatically retrain models.</p>
                <a href="{{ url_for('update_data') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add Data
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="feature-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h5 class="card-title">View Analytics</h5>
                <p class="card-text">Explore detailed analytics, trends, and model performance metrics.</p>
                <a href="{{ url_for('analytics') }}" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>Explore Analytics
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Data Overview -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Recent Price Data</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Price (USD/ton)</th>
                                <th>Change</th>
                            </tr>
                        </thead>
                        <tbody id="recent-data-table">
                            {% for row in recent_data %}
                            <tr>
                                <td>{{ row.Month[:10] }}</td>
                                <td>${{ "%.2f"|format(row['Price(USD/ton)']) }}</td>
                                <td>
                                    {% if loop.index > 1 %}
                                        {% set change = row['Price(USD/ton)'] - recent_data[loop.index-2]['Price(USD/ton)'] %}
                                        <span class="badge bg-{{ 'success' if change >= 0 else 'danger' }}">
                                            {{ "+" if change >= 0 else "" }}{{ "%.2f"|format(change) }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>System Status</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Data Quality</h6>
                    {% set validation = data_summary.validation %}
                    <div class="progress">
                        <div class="progress-bar {% if validation.is_valid %}bg-success{% else %}bg-warning{% endif %}" 
                             style="width: {{ 100 if validation.is_valid else 75 }}%">
                            {{ "Excellent" if validation.is_valid else "Good" }}
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Available Models</h6>
                    <ul class="list-unstyled">
                        {% for model in model_info.available_models %}
                        <li>
                            <i class="fas fa-check-circle text-success me-2"></i>
                            {{ model.upper() }}
                            {% if model == model_info.best_model %}
                                <span class="badge bg-primary">Best</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div class="mb-3">
                    <h6>Last Update</h6>
                    <p class="text-muted">{{ data_summary.metadata.last_updated or 'Unknown' }}</p>
                </div>
                
                <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary">${{ "%.2f"|format(data_summary.metadata.min_price or 0) }}</h3>
                <p class="text-muted">Minimum Price</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary">${{ "%.2f"|format(data_summary.metadata.max_price or 0) }}</h3>
                <p class="text-muted">Maximum Price</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary">${{ "%.2f"|format(data_summary.metadata.std_price or 0) }}</h3>
                <p class="text-muted">Price Volatility</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                {% set trend = data_summary.statistics.recent_trend %}
                <h3 class="text-{{ 'success' if trend.trend_direction == 'increasing' else 'danger' if trend.trend_direction == 'decreasing' else 'warning' }}">
                    {% if trend.trend_direction == 'increasing' %}
                        <i class="fas fa-arrow-up"></i>
                    {% elif trend.trend_direction == 'decreasing' %}
                        <i class="fas fa-arrow-down"></i>
                    {% else %}
                        <i class="fas fa-minus"></i>
                    {% endif %}
                    {{ trend.trend_direction.title() }}
                </h3>
                <p class="text-muted">Recent Trend</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Forecast Preview -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Quick Forecast Preview</h5>
                <button class="btn btn-light btn-sm" onclick="generateQuickForecast()">
                    <i class="fas fa-play me-2"></i>Generate 3-Month Forecast
                </button>
            </div>
            <div class="card-body">
                <div id="quick-forecast-container">
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>Click "Generate 3-Month Forecast" to see a quick prediction</p>
                    </div>
                </div>
                <div id="quick-forecast-loading" class="text-center loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating forecast...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshData() {
    location.reload();
}

function generateQuickForecast() {
    const container = document.getElementById('quick-forecast-container');
    const loading = document.getElementById('quick-forecast-loading');
    
    // Show loading
    container.style.display = 'none';
    loading.style.display = 'block';
    
    // Make API call
    fetch('/forecast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'n_months=3'
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = 'none';
        container.style.display = 'block';
        
        if (data.success) {
            displayQuickForecast(data);
        } else {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error generating forecast: ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        loading.style.display = 'none';
        container.style.display = 'block';
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
    });
}

function displayQuickForecast(data) {
    const container = document.getElementById('quick-forecast-container');
    
    let html = `
        <div class="row">
            <div class="col-md-8">
                <h6>3-Month Forecast (${data.model_used.toUpperCase()})</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Forecast</th>
                                <th>Lower CI</th>
                                <th>Upper CI</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    for (let i = 0; i < data.forecast.length; i++) {
        html += `
            <tr>
                <td>${data.future_dates[i]}</td>
                <td>$${data.forecast[i].toFixed(2)}</td>
                <td>$${data.lower_ci[i].toFixed(2)}</td>
                <td>$${data.upper_ci[i].toFixed(2)}</td>
            </tr>
        `;
    }
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-4">
                <h6>Forecast Summary</h6>
                <ul class="list-unstyled">
                    <li><strong>Model Used:</strong> ${data.model_used.toUpperCase()}</li>
                    <li><strong>Average Forecast:</strong> $${(data.forecast.reduce((a, b) => a + b, 0) / data.forecast.length).toFixed(2)}</li>
                    <li><strong>Generated:</strong> ${new Date().toLocaleString()}</li>
                </ul>
                <a href="/forecast" class="btn btn-primary btn-sm">
                    <i class="fas fa-arrow-right me-2"></i>Full Forecast
                </a>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Auto-refresh data every 5 minutes
setInterval(function() {
    // Only refresh if user is still on the page
    if (document.visibilityState === 'visible') {
        fetch('/api/data_summary')
        .then(response => response.json())
        .then(data => {
            // Update the last update time if changed
            console.log('Data check completed');
        })
        .catch(error => console.log('Background data check failed'));
    }
}, 300000); // 5 minutes
</script>
{% endblock %}
